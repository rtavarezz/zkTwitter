generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  handle       String    @unique
  selfNullifier String?  @unique // Self Protocol nullifier prevents duplicate passport registrations
  avatarUrl    String?
  humanStatus  String
  disclosed    String    @default("{}")
  birthYearCommitment String?     // Poseidon(birthYear, salt) - hides exact age
  birthYearSalt       String?     // Salt for commitment (stored for re-proving)
  generationId        Int?        // Proven generation: 0=GenZ, 1=Millennial, etc.
  generationProofHash String?     // Claim hash from generation proof
  socialProofLevel  Int     @default(0) // Minimum number of verified follows proven via ZK
  socialClaimHash   String?
  socialVerifiedAt  DateTime?
  verifiedAt   DateTime?
  createdAt    DateTime  @default(now())
  tweets       Tweet[]
  loginSessions LoginSession[]
  following    Follow[]  @relation("UserFollowing")
  followers    Follow[]  @relation("UserFollowers")
  sentMessages Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model Tweet {
  id        String   @id @default(uuid())
  body      String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}

model LoginSession {
  id         String   @id @default(uuid())
  sessionId  String   @unique
  userId     String
  handle     String
  status     String   @default("pending")
  token      String?
  createdAt  DateTime @default(now())
  verifiedAt DateTime?
  user       User     @relation(fields: [userId], references: [id])

  @@index([handle])
  @@index([status])
}

model Follow {
  followerId String
  followingId String
  createdAt  DateTime @default(now())

  follower  User @relation("UserFollowing", fields: [followerId], references: [id])
  following User @relation("UserFollowers", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

model Message {
  id          String   @id @default(uuid())
  senderId    String
  recipientId String
  body        String
  createdAt   DateTime @default(now())

  sender    User @relation("SentMessages", fields: [senderId], references: [id])
  recipient User @relation("ReceivedMessages", fields: [recipientId], references: [id])

  @@index([senderId, recipientId])
  @@index([recipientId, senderId])
}

model UsedNonce {
  id           String   @id @default(uuid())
  scope        String
  sessionNonce String   @unique
  createdAt    DateTime @default(now())
}

model Config {
  key   String @id
  value String
}

model VerifiedLeaf {
  id        String   @id @default(uuid())
  leaf      String   @unique
  createdAt DateTime @default(now())
}
